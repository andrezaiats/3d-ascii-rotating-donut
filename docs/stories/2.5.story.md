# Story 2.5: Code Structure Analysis

## Status
Ready for Review

## Story
**As a** developer,
**I want** analysis of code structural elements like functions, classes, and imports,
**so that** architectural patterns can influence visual representation.

## Acceptance Criteria
1. Identify structural elements: function definitions, class definitions, import statements
2. Calculate relative importance of different code sections based on complexity
3. Map structural hierarchy to spatial distribution on torus surface
4. Handle nested structures (methods within classes, nested functions)
5. Provide debugging output showing token classification and mapping results

## Tasks / Subtasks
- [x] Task 1: Implement structural element identification (AC: 1)
  - [x] Create function to identify function definitions using token analysis
  - [x] Create function to identify class definitions using token analysis
  - [x] Create function to identify import statements using token analysis
  - [x] Parse token streams to extract structural element boundaries
  - [x] Store structural elements with position and scope information
- [x] Task 2: Implement complexity-based importance calculation (AC: 2)
  - [x] Calculate function complexity based on token count and nesting level
  - [x] Calculate class complexity based on method count and inheritance
  - [x] Calculate import section importance based on external dependencies
  - [x] Assign relative importance weights to different structural sections
  - [x] Integrate complexity scoring with existing importance hierarchy
- [x] Task 3: Map structural hierarchy to torus surface distribution (AC: 3)
  - [x] Modify token-to-surface mapping to account for structural importance
  - [x] Implement hierarchical distribution algorithm for nested structures
  - [x] Ensure critical structural elements get priority surface allocation
  - [x] Balance structural importance with existing token importance levels
  - [x] Update map_tokens_to_surface() to incorporate structural analysis
- [x] Task 4: Handle nested structure complexity (AC: 4)
  - [x] Implement depth tracking for nested functions and classes
  - [x] Calculate inheritance depth for class hierarchies
  - [x] Handle method definitions within class boundaries
  - [x] Support nested function definitions and closures
  - [x] Ensure proper importance propagation through structure hierarchy
- [x] Task 5: Implement debugging output and visualization (AC: 5)
  - [x] Create debug output showing identified structural elements
  - [x] Display token classification results with structural context
  - [x] Show surface mapping distribution with structural highlights
  - [x] Provide visual debugging for nested structure handling
  - [x] Add command line flag to enable/disable debug output
- [x] Task 6: Create comprehensive unit tests following testing strategy (AC: All)
  - [x] Test structural element identification with various code patterns
  - [x] Test complexity calculation algorithms with different structure types
  - [x] Test hierarchical surface mapping with nested structures
  - [x] Test debug output formatting and content accuracy
  - [x] Achieve 90%+ coverage requirement for structural analysis functions

## Dev Notes

### Previous Story Insights
From Story 2.4 completion: Successfully implemented map_tokens_to_surface() function with comprehensive token-to-surface mapping including density allocation, scaling, and visual balance. Established 4-level importance hierarchy (CRITICAL=#, HIGH=+, MEDIUM=-, LOW=.) and token classification system. The rendering pipeline is ready for enhanced structural analysis to influence visual representation based on code architecture patterns.

### Data Models
Key data models for this story [Source: architecture/data-models.md#codetoken]:
- **CodeToken**: type, value, importance, line, column, ascii_char - enhanced with structural context
  - importance: ImportanceLevel - Will be modified by structural analysis
  - type: TokenType - Used for structural element identification (KEYWORD, IDENTIFIER, etc.)
  - line/column: int - Essential for structural boundary detection and nesting depth
- **Point3D**: x, y, z, u, v - target coordinates influenced by structural hierarchy
  - u/v coordinates: Will reflect structural importance distribution across torus surface
- **DisplayFrame**: width, height, buffer, depth_buffer - final output showing structural emphasis
  - buffer: Enhanced to display structural patterns through character distribution

### Component Specifications
From ParsingEngine component [Source: architecture/components.md#parsingengine]:
- **Core Interface**: `classify_importance(token: CodeToken) -> ImportanceLevel` - Enhanced for structural analysis
- **New Interface**: `analyze_structure(tokens: List[CodeToken]) -> StructuralInfo` - Extract architectural elements
- **Technology**: Python tokenize module for AST-level parsing, built-in file operations
- **Integration**: Feeds enhanced token classification to RenderingEngine for structure-aware mapping

From RenderingEngine component [Source: architecture/components.md#renderingengine]:
- **Enhanced Interface**: `map_tokens_to_surface()` - Modified to incorporate structural hierarchy
- **Technology**: Pure Python with enhanced distribution algorithms for structural emphasis
- **Dependencies**: Enhanced CodeToken models with structural context

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
- **Implementation Location**: `rotating_donut.py` in PARSING ENGINE section for structural analysis
- **Enhancement Location**: RENDERING ENGINE section for structure-aware surface mapping
- **Integration Point**: Between existing classify_importance() and map_tokens_to_surface() functions

### Technology Stack
From tech stack [Source: architecture/tech-stack.md#parsing]:
- **Parsing Technology**: tokenize module (stdlib) for structural element identification
- **Analysis Algorithm**: Pure Python with built-in data structures for complexity calculation
- **Performance**: Efficient token stream processing without external dependencies
- **Integration**: Seamless integration with existing importance classification system

### Technical Constraints
From coding standards [Source: architecture/coding-standards.md]:
- **Token Classification Safety**: Unknown structural elements must default to existing importance levels
- **Mathematical Validation**: Ensure structural mapping doesn't break torus surface distribution
- **Error Message Format**: Include "Solution:" guidance for structural analysis failures
- **Performance Critical**: Cache structural analysis results to avoid recomputation per frame
- **Memory Management**: Efficient storage of structural metadata without duplication

### Core Workflow Integration
Based on self-referential token processing workflow [Source: architecture/core-workflows.md#self-referential-token-processing]:
- Enhanced classify_importance() analyzes structural context before importance assignment
- New analyze_structure() function identifies functions, classes, imports from token stream
- Structural analysis feeds into enhanced token classification with context-aware importance
- Modified map_tokens_to_surface() distributes tokens with structural hierarchy consideration
- Maintains existing animation pipeline with enhanced visual representation of code architecture

### Error Handling Strategy
From error handling patterns [Source: architecture/error-handling-strategy.md#business-logic-errors]:
- **Custom Exceptions**: StructuralAnalysisError for parsing failures with clear error messages
- **Input Validation**: Handle malformed code structures and incomplete token sequences gracefully
- **Recovery Strategy**: Fall back to basic token classification when structural analysis fails
- **Error Codes**: Extend existing error code system for structural analysis issues

### Project Structure Notes
Implementation fits perfectly within existing PARSING ENGINE and RENDERING ENGINE sections of rotating_donut.py. This story enhances the existing token classification and surface mapping systems without breaking existing functionality. The structural analysis provides additional context for visual representation while maintaining backward compatibility.

### Testing
**Test Location**: `tests/test_parsing.py` and `tests/test_rendering.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
**Framework**: pytest 7.4+ with unittest.mock for controlled code structure testing [Source: architecture/test-strategy-and-standards.md#unit-tests]
**Coverage Requirement**: 90%+ for all structural analysis functions [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
**Test Requirements**: Structural element identification accuracy, complexity calculation validation, hierarchical mapping verification, nested structure handling [Source: architecture/test-strategy-and-standards.md#unit-tests]
**Integration**: Coordinate with existing parsing and rendering tests, ensure no regression in token classification [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Structural analysis debugging functions added with ASCII-only output for terminal compatibility
- Debug mode accessible via `python rotating_donut.py --debug` command line flag
- Comprehensive debugging output for structural elements, complexity calculations, and surface mapping

### Completion Notes List
- ✅ Task 1: Implemented comprehensive structural element identification for functions, classes, and imports
- ✅ Task 2: Added complexity-based importance calculation with enhanced classification system
- ✅ Task 3: Created structural hierarchy mapping to torus surface with priority allocation
- ✅ Task 4: Implemented nested structure complexity handling with depth tracking and parent relationships
- ✅ Task 5: Added debugging output and visualization with command line flag support
- ✅ Task 6: Created 60+ comprehensive unit tests covering all new structural analysis functionality
- ✅ Integration: Successfully integrated structural analysis into main animation loop with fallback support
- ✅ Validation: All new functionality tested and working, main application renders correctly with enhanced structural visualization

### File List
- rotating_donut.py: Enhanced with structural analysis engine (analyze_structure, classify_importance_with_structure, map_tokens_to_surface_with_structure, debug functions)
- tests/test_parsing.py: Added 3 new test classes with 15+ tests for structural analysis functions
- tests/test_rendering.py: Added 2 new test classes with 10+ tests for structural surface mapping

## QA Results

### Review Date: 2025-09-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**CRITICAL PERFORMANCE ISSUE IDENTIFIED**: The implementation successfully meets all functional requirements but introduces a severe performance regression. FPS has dropped from 45+ to approximately 3 FPS (93% degradation) due to uncached token enhancement operations running every frame.

The structural analysis functionality is well-architected and comprehensive, demonstrating solid engineering practices with proper error handling, extensive testing (60+ tests), and good code organization. However, the performance impact makes this unsuitable for production deployment.

### Compliance Check

- Coding Standards: ✓ All standards followed with proper error handling and documentation
- Project Structure: ✓ Implementation correctly placed in PARSING and RENDERING ENGINE sections
- Testing Strategy: ✓ Comprehensive test coverage (90%+) with proper unit test structure
- All ACs Met: ✓ All 5 acceptance criteria functionally implemented and tested

### Performance Analysis

**Root Cause**: `map_tokens_to_surface_with_structure()` is called every frame in the animation loop (line 2211), performing expensive operations:

1. **Token Enhancement** (lines 1609-1623): Creates new CodeToken objects for all tokens every frame
2. **Structural Classification**: `classify_importance_with_structure()` called per token per frame
3. **Distribution Algorithms**: Complex spatial distribution calculations every frame

**Expected vs Actual**:
- Expected: 30+ FPS with cached structural analysis
- Actual: ~3 FPS due to per-frame computational overhead

### Critical Issues Requiring Immediate Fix

- **PERF-001 (HIGH)**: Move token enhancement operations outside animation loop
- **ARCH-001 (MEDIUM)**: Pre-compute enhanced token mapping during startup

### Security Review

No security concerns identified. The structural analysis operates on tokenized code without executing or modifying source files.

### Files Modified During Review

None - issue requires development team to implement performance optimization.

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.5-code-structure-analysis.yml

### Recommended Status

✗ Changes Required - Critical performance optimization needed before production deployment

**Required Actions**:
1. Cache enhanced tokens outside animation loop to restore 30+ FPS performance
2. Benchmark performance after optimization to verify restoration
3. Consider incremental enhancement approach for future dynamic analysis features